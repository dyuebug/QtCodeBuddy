# 第4章：信号与槽

## 一、本章概述

### 1.1 学习目标

- 深入理解信号与槽机制
- 掌握多种连接方式
- 学会自定义信号和槽

### 1.2 核心知识点

| 知识点 | 重要程度 | 说明 |
|--------|----------|------|
| connect() | ★★★★★ | 连接信号和槽 |
| 自定义信号 | ★★★★★ | signals 关键字 |
| Lambda 槽 | ★★★★☆ | 内联槽函数 |
| disconnect() | ★★★☆☆ | 断开连接 |

---

## 二、信号与槽基础

### 2.1 是什么？

信号与槽是 Qt 的**核心通信机制**：
- **信号（Signal）**：对象状态改变时发出的通知
- **槽（Slot）**：响应信号的函数

### 2.2 为什么用它？

- 实现对象间的松耦合通信
- 类型安全（编译时检查）
- 支持一对多、多对一连接

### 2.3 基本语法

```cpp
connect(发送者, &发送者类::信号, 接收者, &接收者类::槽);
```

### 2.4 简单示例

```cpp
QPushButton *btn = new QPushButton("点击");

// 连接按钮的 clicked 信号到槽函数
connect(btn, &QPushButton::clicked,
        this, &MyWidget::onButtonClicked);
```

---

## 三、连接方式详解

### 3.1 成员函数指针（推荐）

```cpp
connect(m_button, &QPushButton::clicked,
        this, &MyWidget::onClicked);
```

**优点**：编译时类型检查，IDE 自动补全。

### 3.2 Lambda 表达式

```cpp
connect(m_button, &QPushButton::clicked, [this]() {
    m_label->setText("按钮被点击了");
});
```

**优点**：代码简洁，适合简单操作。

### 3.3 带参数的信号

```cpp
// 信号有重载时，需要指定具体版本
connect(m_spinBox, QOverload<int>::of(&QSpinBox::valueChanged),
        this, &MyWidget::onValueChanged);
```

---

## 四、自定义信号

### 4.1 声明信号

```cpp
class Counter : public QObject
{
    Q_OBJECT

signals:
    void valueChanged(int newValue);
    void maxReached();
};
```

**注意**：信号只需声明，不需要实现。

### 4.2 发射信号

```cpp
void Counter::setValue(int value)
{
    if (m_value != value) {
        m_value = value;
        emit valueChanged(m_value);  // 发射信号
    }
}
```

---

## 五、多重连接

### 5.1 一个信号连接多个槽

```cpp
// 一个按钮点击触发多个操作
connect(m_button, &QPushButton::clicked, [this]() {
    m_label->setText("按钮被点击了！");
});

connect(m_button, &QPushButton::clicked, [this]() {
    QMessageBox::information(this, "提示", "这是第二个槽！");
});

connect(m_button, &QPushButton::clicked, [this]() {
    m_button->setText("再次点击");
});
```

**注意**：槽函数的执行顺序与连接顺序一致。

### 5.2 多个信号连接一个槽

```cpp
// 三个按钮都连接到同一个槽函数
connect(m_sender1, &QPushButton::clicked, this, &MyWidget::onCommonSlot);
connect(m_sender2, &QPushButton::clicked, this, &MyWidget::onCommonSlot);
connect(m_sender3, &QPushButton::clicked, this, &MyWidget::onCommonSlot);

// 在槽函数中使用 sender() 获取发送者
void MyWidget::onCommonSlot()
{
    QPushButton *btn = qobject_cast<QPushButton*>(sender());
    if (btn) {
        qDebug() << "点击的按钮:" << btn->text();
    }
}
```

---

## 六、断开连接

```cpp
// 断开特定连接
disconnect(m_button, &QPushButton::clicked,
           this, &MyWidget::onClicked);

// 断开对象的所有连接
disconnect(m_button, nullptr, nullptr, nullptr);
```

---

## 七、阻止信号循环

```cpp
// 双向同步时防止死循环
m_slider->blockSignals(true);
m_slider->setValue(value);
m_slider->blockSignals(false);
```

---

## 八、获取发送者

```cpp
void MyWidget::onCommonSlot()
{
    QPushButton *btn = qobject_cast<QPushButton*>(sender());
    if (btn) {
        qDebug() << "点击的按钮:" << btn->text();
    }
}
```

---

## 九、本章小结

| 概念 | 说明 |
|------|------|
| 信号 | 对象状态改变时发出的通知 |
| 槽 | 响应信号的函数 |
| emit | 发射信号的关键字 |
| connect | 连接信号和槽 |
| disconnect | 断开连接 |

---

## 十、练习题

1. 创建一个自定义计数器类，包含 increment/decrement 方法
2. 添加 valueChanged 信号，值改变时发射
3. 连接到 QLabel 显示当前值
