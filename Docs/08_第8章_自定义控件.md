# 第8章：自定义控件

## 一、本章概述

### 1.1 学习目标

- 学会创建自定义控件
- 掌握自定义绑定技术
- 理解 Q_PROPERTY 属性系统
- 学会处理自定义控件的鼠标事件

### 1.2 核心知识点

| 知识点 | 重要程度 | 说明 |
|--------|----------|------|
| paintEvent | ★★★★★ | 自定义绑制 |
| Q_PROPERTY | ★★★★☆ | 属性系统 |
| 鼠标事件 | ★★★★☆ | 控件交互 |
| sizeHint | ★★★☆☆ | 推荐大小 |

---

## 二、自定义绑制基础

### 2.1 重写 paintEvent

```cpp
void MyWidget::paintEvent(QPaintEvent *event)
{
    QPainter painter(this);
    painter.setRenderHint(QPainter::Antialiasing);

    // 绑制圆形
    painter.setBrush(Qt::blue);
    painter.drawEllipse(rect().center(), 50, 50);
}
```

### 2.2 触发重绘

```cpp
void MyWidget::setValue(int value)
{
    if (m_value != value) {
        m_value = value;
        update();  // 触发重绘
        emit valueChanged(m_value);
    }
}
```

---

## 三、Q_PROPERTY 属性系统

### 3.1 声明属性

```cpp
class MyWidget : public QWidget
{
    Q_OBJECT
    Q_PROPERTY(int value READ value WRITE setValue NOTIFY valueChanged)
    Q_PROPERTY(QColor color READ color WRITE setColor)

public:
    int value() const { return m_value; }
    void setValue(int v);

    QColor color() const { return m_color; }
    void setColor(const QColor &c);

signals:
    void valueChanged(int value);

private:
    int m_value = 0;
    QColor m_color = Qt::blue;
};
```

### 3.2 属性的作用

- 可在 Qt Designer 中编辑
- 支持动画系统
- 支持样式表访问

---

## 四、处理鼠标事件

```cpp
void ColorPickerWidget::mousePressEvent(QMouseEvent *event)
{
    if (event->button() == Qt::LeftButton) {
        QColor color = colorFromPosition(event->pos());
        setSelectedColor(color);
        emit colorSelected(color);
    }
    QWidget::mousePressEvent(event);
}

void ColorPickerWidget::enterEvent(QEnterEvent *event)
{
    m_isHovered = true;
    update();
    QWidget::enterEvent(event);
}

void ColorPickerWidget::leaveEvent(QEvent *event)
{
    m_isHovered = false;
    update();
    QWidget::leaveEvent(event);
}
```

---

## 五、圆形进度条示例

### 5.1 类声明

```cpp
class CircularProgressBar : public QWidget
{
    Q_OBJECT
    Q_PROPERTY(double value READ value WRITE setValue NOTIFY valueChanged)
    Q_PROPERTY(QColor progressColor READ progressColor WRITE setProgressColor)

public:
    explicit CircularProgressBar(QWidget *parent = nullptr);

    double value() const { return m_value; }
    void setValue(double value);

    QSize sizeHint() const override;

signals:
    void valueChanged(double value);

protected:
    void paintEvent(QPaintEvent *event) override;

private:
    double m_value = 0;
    double m_minimum = 0;
    double m_maximum = 100;
    QColor m_progressColor = Qt::blue;
};
```

### 5.2 绑制实现

```cpp
void CircularProgressBar::paintEvent(QPaintEvent *event)
{
    QPainter painter(this);
    painter.setRenderHint(QPainter::Antialiasing);

    int side = qMin(width(), height());
    QRectF rect((width() - side) / 2.0, (height() - side) / 2.0,
                side, side);
    rect.adjust(10, 10, -10, -10);

    // 绑制背景圆
    painter.setPen(QPen(Qt::lightGray, 8));
    painter.drawEllipse(rect);

    // 绑制进度弧
    double angle = 360.0 * (m_value - m_minimum) / (m_maximum - m_minimum);
    painter.setPen(QPen(m_progressColor, 8, Qt::SolidLine, Qt::RoundCap));
    painter.drawArc(rect, 90 * 16, -angle * 16);

    // 绘制文本
    painter.setPen(Qt::black);
    painter.drawText(rect, Qt::AlignCenter,
                     QString("%1%").arg(int(m_value)));
}
```

---

## 六、推荐大小

```cpp
QSize CircularProgressBar::sizeHint() const
{
    return QSize(120, 120);
}

QSize CircularProgressBar::minimumSizeHint() const
{
    return QSize(60, 60);
}
```

---

## 七、本章小结

| 技术 | 用途 |
|------|------|
| paintEvent | 自定义绑制 |
| Q_PROPERTY | 属性绑定 |
| update() | 触发重绘 |
| sizeHint() | 推荐大小 |
| 鼠标事件 | 用户交互 |

---

## 八、练习题

1. 创建一个自定义的开关按钮控件
2. 实现一个带动画效果的进度条
