# 第5章：事件处理

## 一、本章概述

### 1.1 学习目标

- 理解 Qt 事件处理机制
- 掌握常用事件的重写方法
- 学会使用事件过滤器

### 1.2 核心知识点

| 知识点 | 重要程度 | 说明 |
|--------|----------|------|
| 鼠标事件 | ★★★★★ | 点击、移动、滚轮 |
| 键盘事件 | ★★★★★ | 按键、释放 |
| 窗口事件 | ★★★★☆ | 大小、位置、关闭 |
| 焦点事件 | ★★★★☆ | 获得、失去焦点 |
| 定时器事件 | ★★★★☆ | 定时触发 |
| 事件过滤器 | ★★★★☆ | 拦截和处理事件 |

---

## 二、事件 vs 信号

| 特性 | 事件 | 信号 |
|------|------|------|
| 来源 | 系统或 Qt 内部 | 对象主动发出 |
| 处理方式 | 重写虚函数 | connect 连接槽 |
| 传递方向 | 从子到父 | 任意方向 |
| 典型场景 | 鼠标点击、键盘输入 | 按钮点击、值改变 |

---

## 三、鼠标事件

### 3.1 重写鼠标事件

```cpp
void MyWidget::mousePressEvent(QMouseEvent *event)
{
    if (event->button() == Qt::LeftButton) {
        qDebug() << "左键点击:" << event->pos();
    }
    QWidget::mousePressEvent(event);
}
```

### 3.2 常用鼠标事件

| 事件函数 | 触发时机 |
|----------|----------|
| `mousePressEvent` | 鼠标按下 |
| `mouseReleaseEvent` | 鼠标释放 |
| `mouseDoubleClickEvent` | 双击 |
| `mouseMoveEvent` | 鼠标移动 |
| `wheelEvent` | 滚轮滚动 |

---

## 四、键盘事件

```cpp
void MyWidget::keyPressEvent(QKeyEvent *event)
{
    if (event->key() == Qt::Key_Escape) {
        close();
    }
    QWidget::keyPressEvent(event);
}
```

---

## 五、焦点事件

### 5.1 焦点事件函数

```cpp
void MyWidget::focusInEvent(QFocusEvent *event)
{
    qDebug() << "获得焦点";
    QWidget::focusInEvent(event);
}

void MyWidget::focusOutEvent(QFocusEvent *event)
{
    qDebug() << "失去焦点";
    QWidget::focusOutEvent(event);
}
```

### 5.2 通过事件过滤器捕获焦点

```cpp
bool MyWidget::eventFilter(QObject *watched, QEvent *event)
{
    if (event->type() == QEvent::FocusIn) {
        qDebug() << watched->objectName() << "获得焦点";
    } else if (event->type() == QEvent::FocusOut) {
        qDebug() << watched->objectName() << "失去焦点";
    }
    return QWidget::eventFilter(watched, event);
}
```

---

## 六、定时器事件

### 6.1 使用 QTimer

```cpp
// 创建定时器
QTimer *timer = new QTimer(this);
timer->setInterval(1000);  // 1秒

// 连接超时信号
connect(timer, &QTimer::timeout, this, [this]() {
    qDebug() << "定时器触发";
});

// 启动/停止
timer->start();
timer->stop();
```

### 6.2 单次定时器

```cpp
// 延迟执行一次
QTimer::singleShot(2000, this, [this]() {
    qDebug() << "2秒后执行";
});
```

---

## 七、窗口事件

```cpp
void MyWidget::closeEvent(QCloseEvent *event)
{
    if (maybeSave()) {
        event->accept();
    } else {
        event->ignore();
    }
}
```

---

## 八、事件过滤器

```cpp
// 安装过滤器
m_lineEdit->installEventFilter(this);

// 重写过滤函数
bool MyWidget::eventFilter(QObject *obj, QEvent *event)
{
    if (obj == m_lineEdit && event->type() == QEvent::KeyPress) {
        QKeyEvent *keyEvent = static_cast<QKeyEvent*>(event);
        if (keyEvent->key() >= Qt::Key_0 && keyEvent->key() <= Qt::Key_9) {
            return true;  // 过滤数字键
        }
    }
    return QWidget::eventFilter(obj, event);
}
```

---

## 九、本章小结

| 事件类型 | 常用函数 |
|----------|----------|
| 鼠标 | mousePressEvent, mouseMoveEvent |
| 键盘 | keyPressEvent, keyReleaseEvent |
| 焦点 | focusInEvent, focusOutEvent |
| 定时器 | QTimer::timeout |
| 窗口 | closeEvent, resizeEvent |

---

## 十、练习题

1. 创建一个可拖动的窗口
2. 实现按 ESC 键关闭窗口
